<!DOCTYPE html>
<html lang="en">

<head>
	<title>实行基于深度学习的锂电池表面缺陷检测系统| products</title>
	<link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all" />
	<link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" media="all" />
	<link href="css/style.css" rel="stylesheet" type="text/css" media="all" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="keywords" content="缺陷检测系统" />
	<script type="application/x-javascript">
        addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false);
        function hideURLbar() { window.scrollTo(0,1); }
    </script>
	<link
		href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,300i,400,400i,700,700i&subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese"
		rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
	<script>
		$(document).ready(function () {
			$(".dropdown").hover(
				function () {
					$('.dropdown-menu', this).stop(true, true).slideDown("fast");
					$(this).toggleClass('open');
				},
				function () {
					$('.dropdown-menu', this).stop(true, true).slideUp("fast");
					$(this).toggleClass('open');
				}
			);
		});
	</script>
	<style>
		* {
			box-sizing: border-box;
		}

		body {
			background-image: url('./images/background.jpg');
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
		}

		.header {
			text-align: center;
			margin-top: 20px;
			font-size: 24px;
			color: #333;
		}

		.dropArea {
			display: flex;
			align-content: flex-start;
			flex-wrap: wrap;
			position: relative;
			margin: 0 auto;
			width: 800px;
			height: 300px;
			border: 5px dashed #4caf50;
			background-color: #f9f9f9;
			overflow: hidden;
			cursor: pointer;
			transition: border-color 0.3s ease;
			opacity: 0.4;
			/* 40% 透明度 */
		}

		.dropArea:hover {
			border-color: #45a049;
		}

		.dropArea.dragover {
			border-color: #45a049;
			background-color: #e0f7fa;
		}

		.file-input {
			display: none !important;
		}

		.tip {
			position: absolute;
			height: 100%;
			width: 100%;
			font-size: 2em;
			font-weight: 900;
			/* 更粗的字体 */
			text-align: center;
			line-height: 300px;
			/* 与 .dropArea 高度一致 */
			color: rgba(0, 0, 0);
		}

		.imageDisplayArea {
			width: 900px;
			margin: 20px auto;
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
		}

		.compress-list-item {
			padding: 10px;
			width: 33.33%;
			height: 150px;
			position: relative;
		}

		.compress-list-preview {
			width: 100%;
			height: 100%;
			background-size: cover;
			background-position: center;
			border: 2px solid #ddd;
			border-radius: 8px;
			transition: transform 0.3s ease;
		}

		.compress-list-preview:hover {
			transform: scale(1.05);
		}

		/* 删除按钮样式 */
		.delete-button {
			position: absolute;
			right: 5px;
			top: 5px;
			background-color: rgba(255, 0, 0, 0.7);
			color: white;
			border: none;
			border-radius: 50%;
			width: 24px;
			height: 24px;
			font-size: 14px;
			line-height: 24px;
			text-align: center;
			cursor: pointer;
			z-index: 10;
			opacity: 0;
			transition: opacity 0.3s;
		}

		.compress-list-item:hover .delete-button {
			opacity: 1;
		}

		.button-container {
			display: flex;
			justify-content: center;
			gap: 20px;
			margin: 20px auto;
		}

		.submit-button {
			padding: 10px 20px;
			font-size: 16px;
			background-color: #4caf50;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.submit-button:hover {
			background-color: #45a049;
		}

		.progress-container {
			margin: 20px auto;
			text-align: center;
			width: 80%;
			padding: 10px;
		}

		/* 弹窗样式 - 更大的弹窗 */
		.modal {
			display: none;
			justify-content: center;
			align-items: center;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.8);
		}

		/* 显示时的样式 */
		.modal-visible {
			display: flex;
		}

		.modal-content {
			background-color: #fff;
			padding: 20px;
			border-radius: 8px;
			max-width: 95%;
			max-height: 95%;
			width: 1200px;
			overflow-y: auto;
		}

		.close {
			color: #aaa;
			float: right;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}

		.close:hover,
		.close:focus {
			color: black;
			text-decoration: none;
			cursor: pointer;
		}

		/* 处理后的图片样式 */
		.processed-item {
			width: 40%;
			height: 300px;
			margin: 15px;
			position: relative;
			display: flex;
			flex-direction: column;
		}

		.processed-preview {
			width: 100%;
			height: 85%;
			background-size: contain;
			background-position: center;
			background-repeat: no-repeat;
			border: 2px solid #ddd;
			border-radius: 8px;
		}

		.download-button {
			margin-top: 10px;
			padding: 8px 15px;
			background-color: #4caf50;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			text-align: center;
			text-decoration: none;
			display: inline-block;
			font-size: 14px;
			transition: background-color 0.3s;
		}

		.download-button:hover {
			background-color: #45a049;
		}
	</style>
</head>

<body>
	<!-- header -->
	<header>
		<div class="w3layouts-top-strip">
			<div class="container">
				<div class="logo">
					<h1><a href="index.html"><span>识 </span>痕</a></h1>
				</div>

				<div class="clearfix"></div>
			</div>
		</div>
		<!-- navigation -->
		<nav class="navbar navbar-default">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
						data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
				</div>
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li><a href="index.html">首页</a></li>
						<li><a href="about.html">关于我们</a></li>
						<li><a href="services.html">数据集介绍</a></li>
						<li><a class="active" href="products.html">缺陷检测</a></li>

						<li><a href="contact.html">联系我们</a></li>
					</ul>
				</div>
			</div>
		</nav>
	</header>

	<!-- banner -->


	<!-- products -->
	<div class="agile-prod">
		<div class="container">
			<h2 class="w3ls_head">缺陷<span>检测</span></h2>
			<div class="demo">


				<!-- 拖拽区域 -->
				<div class="dropArea" @click="triggerFileInput" @dragover.prevent="handleDragOver"
					@dragenter.prevent="handleDragEnter" @dragleave.prevent="handleDragLeave"
					@drop.prevent="handleDrop">
					<div class="tip">点击或拖拽图片到这里</div>
				</div>

				<!-- 隐藏的文件输入框 -->
				<input type="file" id="fileInput" class="file-input" multiple @change="handleFileChange">

				<div class="header">
					<h2 class="w3ls_head">图片<span>预览</span></h2>
				</div>

				<div class="imageDisplayArea">
					<div v-for="(url, index) in imageUrls" :key="index" class="compress-list-item">
						<button class="delete-button" @click="deleteImage(index)">×</button>
						<div class="compress-list-preview" :style="{ backgroundImage: 'url(' + url + ')' }"></div>
					</div>
				</div>

				<div v-if="uploading" class="progress-container">
					<p>上传进度: {{ uploadProgress }}%</p>
					<progress :value="uploadProgress" max="100"></progress>
				</div>

				<!-- 按钮容器 -->
				<div class="button-container">
					<button @click="submitImages" class="submit-button">提交图片</button>
					<button @click="fetchProcessedImages" class="submit-button">获取处理后的图片</button>
				</div>

				<!-- 弹窗 - 更大的弹窗和下载按钮 -->
				<div v-cloak class="modal" :class="{ 'modal-visible': isModalVisible }" @click="closeModal">
					<div class="modal-content" @click.stop>
						<span class="close" @click="closeModal">&times;</span>
						<div class="header">
							<h2>处理后的图片</h2>
						</div>
						<div class="imageDisplayArea">
							<div v-for="(item, index) in processedImages" :key="index" class="processed-item">
								<div class="processed-preview" :style="{ backgroundImage: 'url(' + item.url + ')' }">
								</div>
								<a :href="item.url" :download="'processed_' + item.filename"
									class="download-button">下载图片</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- footer -->
	<div class="footer">
		Copyright © 2025 识痕项目组 &nbsp;&nbsp;&nbsp;四川大学计算机学院 &nbsp;&nbsp;&nbsp;<a href="#">隐私政策</a>
	</div>
	<!-- footer -->

</body>
<!-- 引入必要的JavaScript库 -->
<script src="js/bootstrap.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- Vue应用程序代码 -->
<script>
	const { createApp, ref, onMounted } = Vue;

	const app = createApp({
		setup() {
			// 状态定义
			const images = ref([]);
			const imageUrls = ref([]);
			const processedImageUrls = ref([]);
			const processedImages = ref([]);
			const isModalVisible = ref(false);
			const uploading = ref(false);
			const uploadProgress = ref(0);
			const isDragging = ref(false);

			// 初始化时确保模态框是关闭的
			onMounted(() => {
				isModalVisible.value = false;
			});

			// 关闭模态框
			const closeModal = () => {
				isModalVisible.value = false;
			};

			// 触发文件选择
			const triggerFileInput = () => {
				document.getElementById('fileInput').click();
			};

			// 处理文件选择
			const handleFileChange = (event) => {
				const files = event.target.files;
				if (files && files.length > 0) {
					for (let i = 0; i < files.length; i++) {
						const file = files[i];
						if (file instanceof File) {
							images.value.push(file);
							const url = URL.createObjectURL(file);
							imageUrls.value.push(url);
						} else {
							console.error("Invalid file object:", file);
						}
					}
				}
			};

			// 删除图片
			const deleteImage = (index) => {
				// 释放对象URL避免内存泄漏
				URL.revokeObjectURL(imageUrls.value[index]);
				// 从数组中移除
				images.value.splice(index, 1);
				imageUrls.value.splice(index, 1);
			};

			// 处理拖拽相关事件
			const handleDragOver = (event) => {
				event.preventDefault();
				isDragging.value = true;
			};

			const handleDragEnter = (event) => {
				event.preventDefault();
				isDragging.value = true;
			};

			const handleDragLeave = (event) => {
				event.preventDefault();
				isDragging.value = false;
			};

			const handleDrop = (event) => {
				event.preventDefault();
				isDragging.value = false;
				const files = event.dataTransfer.files;
				if (files && files.length > 0) {
					for (let i = 0; i < files.length; i++) {
						const file = files[i];
						if (file instanceof File) {
							images.value.push(file);
							const url = URL.createObjectURL(file);
							imageUrls.value.push(url);
						} else {
							console.error("Invalid file object:", file);
						}
					}
				}
			};

			// 提交图片到服务器
			const submitImages = async () => {
				if (images.value.length === 0) {
					alert("请先选择要上传的图片");
					return;
				}

				try {
					const formData = new FormData();
					images.value.forEach((file) => {
						formData.append("images", file);
					});

					uploading.value = true;
					uploadProgress.value = 0;

					const response = await axios.post(
						"http://localhost:5000/api/submit-images",
						formData,
						{
							headers: {
								"Content-Type": "multipart/form-data",
							},
							onUploadProgress: (progressEvent) => {
								if (progressEvent.lengthComputable) {
									uploadProgress.value = Math.round(
										(progressEvent.loaded * 100) / progressEvent.total
									);
								}
							},
						}
					);

					alert("图片提交成功！");
				} catch (error) {
					console.error("上传失败:", error);
					alert("图片提交失败：" + (error.response?.data?.message || error.message));
				} finally {
					uploading.value = false;
				}
			};

			// 获取处理后的图片
			const fetchProcessedImages = async () => {
				if (images.value.length === 0) {
					alert("没有可获取的图片");
					return;
				}

				try {
					processedImages.value = [];
					const fetchPromises = images.value.map((image) => {
						const filename = image.name;
						// 对文件名中的空格进行编码，保留其他字符不变
						const encodedFilename = filename.replace(/ /g, '%20');
						return axios
							.get(`http://localhost:5000/api/download-image/${encodedFilename}`, {
								responseType: "blob",
							})
							.then((response) => {
								const imageBlob = response.data;
								const imageObjectUrl = URL.createObjectURL(imageBlob);
								return {
									url: imageObjectUrl,
									filename: filename
								};
							})
							.catch((error) => {
								console.error("获取图片失败:", error);
								return null;
							});
					});

					const results = await Promise.all(fetchPromises);
					processedImages.value = results.filter(item => item !== null);

					if (processedImages.value.length === 0) {
						alert("没有找到处理后的图片");
						return;
					}

					isModalVisible.value = true; // 显示弹窗
				} catch (error) {
					console.error("获取处理后的所有图片失败:", error);
					alert("获取处理后的图片失败，请重试");
				}
			};

			// 返回所有需要在模板中使用的变量和方法
			return {
				images,
				imageUrls,
				processedImageUrls,
				processedImages,
				isModalVisible,
				uploading,
				uploadProgress,
				isDragging,
				triggerFileInput,
				handleFileChange,
				deleteImage,
				handleDragOver,
				handleDragEnter,
				handleDragLeave,
				handleDrop,
				submitImages,
				fetchProcessedImages,
				closeModal
			};
		},
	});

	// 挂载Vue应用
	app.mount('.demo');
</script>

</html>